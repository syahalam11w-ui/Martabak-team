<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard | Kyoutaka Membership</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #7b68ee; --primary-glow: rgba(123,104,238,0.6); --secondary: #00f5d4; --accent: #ff6b9d; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --dark: #0a0a1a; --darker: #050510; --light: #f8f9ff; --glass: rgba(255,255,255,0.03); --glass-border: rgba(255,255,255,0.08); --card-bg: rgba(20,20,40,0.6); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--darker); color: var(--light); min-height: 100vh; overflow-x: hidden; }
        .bg-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(123,104,238,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(123,104,238,0.05) 1px, transparent 1px); background-size: 40px 40px; z-index: -1; animation: gridMove 30s linear infinite; }
        @keyframes gridMove { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(40px); } }
        .bg-glow { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 80vw; height: 80vh; background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); z-index: -1; pointer-events: none; }
        
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 80px; background: rgba(10,10,25,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 5%; z-index: 1000; animation: slideDown 0.8s ease; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .nav-logo { font-family: 'Orbitron', monospace; font-size: 1.6rem; font-weight: 900; color: var(--light); text-decoration: none; display: flex; align-items: center; gap: 10px; letter-spacing: 2px; }
        .nav-logo span { color: var(--secondary); }
        .nav-logo:hover { text-shadow: 0 0 20px var(--primary-glow); }
        .nav-links { display: flex; gap: 1rem; }
        .nav-btn { padding: 10px 24px; border-radius: 30px; border: 1px solid var(--glass-border); background: var(--glass); color: var(--light); text-decoration: none; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px); }
        .nav-btn:hover { background: var(--primary); border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(123,104,238,0.3); }
        .nav-btn.active { background: linear-gradient(135deg, var(--gold), #ffed4e); color: #000; border: none; font-weight: 600; }
        .nav-btn.home-link { background: linear-gradient(135deg, var(--secondary), #00b894); border: none; color: #000; }
        
        .hero { padding: 160px 20px 60px; text-align: center; position: relative; }
        .hero-title { font-family: 'Orbitron', monospace; font-size: 3.5rem; font-weight: 900; margin-bottom: 1rem; background: linear-gradient(135deg, var(--gold), var(--accent), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: textGlow 3s ease-in-out infinite alternate; }
        @keyframes textGlow { from { filter: drop-shadow(0 0 10px rgba(255,215,0,0.3)); } to { filter: drop-shadow(0 0 30px rgba(255,215,0,0.6)); } }
        .hero-subtitle { font-size: 1.1rem; color: var(--secondary); letter-spacing: 2px; margin-bottom: 3rem; }
        
        .podium-container { max-width: 1000px; margin: 0 auto 4rem; padding: 0 20px; }
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 1rem; margin-bottom: 3rem; perspective: 1000px; flex-wrap: wrap; }
        .podium-item { position: relative; text-align: center; animation: podiumEnter 0.8s ease both; }
        @keyframes podiumEnter { from { opacity: 0; transform: translateY(50px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .podium-item:nth-child(1) { animation-delay: 0.1s; }
        .podium-item:nth-child(2) { animation-delay: 0.2s; }
        .podium-item:nth-child(3) { animation-delay: 0.3s; }
        
        .podium-card { width: 220px; padding: 2rem 1.5rem; border-radius: 20px; background: var(--card-bg); border: 2px solid var(--glass-border); backdrop-filter: blur(10px); transition: all 0.3s; position: relative; overflow: hidden; }
        .podium-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .podium-item.gold .podium-card { border-color: var(--gold); box-shadow: 0 0 40px rgba(255,215,0,0.3); transform: scale(1.1) translateY(-20px); }
        .podium-item.gold .podium-card::before { background: linear-gradient(90deg, var(--gold), #ffed4e); }
        .podium-item.silver .podium-card { border-color: var(--silver); box-shadow: 0 0 30px rgba(192,192,192,0.2); }
        .podium-item.silver .podium-card::before { background: linear-gradient(90deg, var(--silver), #e8e8e8); }
        .podium-item.bronze .podium-card { border-color: var(--bronze); box-shadow: 0 0 30px rgba(205,127,50,0.2); }
        .podium-item.bronze .podium-card::before { background: linear-gradient(90deg, var(--bronze), #e8945f); }
        .podium-card:hover { transform: translateY(-10px); }
        .podium-item.gold .podium-card:hover { transform: scale(1.1) translateY(-30px); }        
        .rank-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', monospace; font-size: 1.5rem; font-weight: 900; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .rank-1 { background: linear-gradient(135deg, var(--gold), #ffed4e); color: #000; }
        .rank-2 { background: linear-gradient(135deg, var(--silver), #e8e8e8); color: #000; }
        .rank-3 { background: linear-gradient(135deg, var(--bronze), #e8945f); color: #fff; }
        
        .podium-photo { width: 100px; height: 100px; border-radius: 50%; margin: 1rem auto; border: 4px solid; overflow: hidden; background: #000; }
        .podium-item.gold .podium-photo { border-color: var(--gold); }
        .podium-item.silver .podium-photo { border-color: var(--silver); }
        .podium-item.bronze .podium-photo { border-color: var(--bronze); }
        .podium-photo img { width: 100%; height: 100%; object-fit: cover; }
        
        .podium-name { font-family: 'Orbitron', monospace; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.3rem; }
        .podium-title { font-size: 0.85rem; color: var(--secondary); margin-bottom: 0.5rem; }
        .podium-status { display: inline-block; padding: 4px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-founder { background: rgba(255,107,157,0.2); color: var(--accent); border: 1px solid var(--accent); }
        .status-admin { background: rgba(0,245,212,0.2); color: var(--secondary); border: 1px solid var(--secondary); }
        .status-vip { background: rgba(255,215,0,0.2); color: var(--gold); border: 1px solid var(--gold); }
        .status-member { background: rgba(123,104,238,0.2); color: var(--primary); border: 1px solid var(--primary); }
        
        .leaderboard-container { max-width: 900px; margin: 0 auto 100px; padding: 0 20px; }
        .section-title { font-family: 'Orbitron', monospace; font-size: 1.8rem; margin-bottom: 2rem; text-align: center; color: var(--light); display: flex; align-items: center; justify-content: center; gap: 12px; }
        .section-title i { color: var(--gold); }
        
        .leaderboard-list { display: flex; flex-direction: column; gap: 1rem; }
        .leader-item { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 1.2rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; transition: all 0.3s; backdrop-filter: blur(10px); animation: slideIn 0.5s ease both; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        .leader-item:hover { border-color: var(--primary); transform: translateX(10px); box-shadow: 0 10px 30px rgba(123,104,238,0.2); }
        
        .leader-rank { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', monospace; font-size: 1.3rem; font-weight: 700; flex-shrink: 0; }
        .leader-rank.top-1 { background: linear-gradient(135deg, var(--gold), #ffed4e); color: #000; box-shadow: 0 0 20px rgba(255,215,0,0.4); }
        .leader-rank.top-2 { background: linear-gradient(135deg, var(--silver), #e8e8e8); color: #000; box-shadow: 0 0 20px rgba(192,192,192,0.3); }
        .leader-rank.top-3 { background: linear-gradient(135deg, var(--bronze), #e8945f); color: #fff; box-shadow: 0 0 20px rgba(205,127,50,0.3); }
        .leader-rank.normal { background: var(--glass); color: var(--light); border: 1px solid var(--glass-border); }
        
        .leader-photo { width: 60px; height: 60px; border-radius: 12px; overflow: hidden; border: 2px solid var(--primary); flex-shrink: 0; }
        .leader-photo img { width: 100%; height: 100%; object-fit: cover; }
        
        .leader-info { flex: 1; min-width: 0; }
        .leader-name { font-family: 'Orbitron', monospace; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.2rem; }
        .leader-title { font-size: 0.85rem; color: var(--secondary); }
        .leader-id { font-family: 'Orbitron', monospace; font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.3rem; }
        
        .leader-status { padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; flex-shrink: 0; }
        
        .empty-state { text-align: center; padding: 4rem; color: rgba(255,255,255,0.4); animation: fadeIn 0.5s ease; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; display: block; color: var(--glass-border); }
        .empty-state p { font-size: 1.1rem; }
        
        .loading-state { text-align: center; padding: 4rem; }        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--glass-border); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-state { text-align: center; padding: 4rem; background: rgba(255,71,87,0.1); border: 1px solid var(--danger); border-radius: 16px; margin: 2rem 0; }
        .error-state i { font-size: 3rem; color: var(--danger); margin-bottom: 1rem; display: block; }
        .error-state p { color: var(--light); margin-bottom: 1rem; }
        .error-state code { background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; display: block; margin-top: 1rem; }
        .btn-retry { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; margin-top: 1rem; transition: all 0.3s; }
        .btn-retry:hover { background: var(--primary-glow); transform: translateY(-2px); }
        
        .db-status { position: fixed; top: 90px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(10px); z-index: 999; }
        .db-status.online { background: rgba(0,245,212,0.15); color: var(--secondary); border: 1px solid var(--secondary); }
        .db-status.offline { background: rgba(255,71,87,0.15); color: var(--danger); border: 1px solid var(--danger); }
        .db-status.dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 2.2rem; }
            .podium { flex-direction: column; align-items: center; }
            .podium-item.gold .podium-card { transform: scale(1); }
            .podium-item.gold .podium-card:hover { transform: scale(1.02) translateY(-10px); }
            .podium-card { width: 100%; max-width: 300px; }
            .leader-item { flex-wrap: wrap; }
            .leader-rank { width: 40px; height: 40px; font-size: 1.1rem; }
            .leader-photo { width: 50px; height: 50px; }
            .navbar { padding: 0 15px; }
            .nav-logo { font-size: 1.2rem; }
            .nav-links { gap: 0.5rem; }
            .nav-btn { padding: 8px 16px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="bg-glow"></div>

    <nav class="navbar">
        <a href="member.html" class="nav-logo"><i class="fas fa-crown"></i> KYOUTAKA <span>MEMBERSHIP</span></a>
        <div class="nav-links">
            <a href="member.html" class="nav-btn home-link"><i class="fas fa-home"></i> Members</a>
            <a href="leaderboard.html" class="nav-btn active"><i class="fas fa-trophy"></i> Leaderboard</a>
        </div>
    </nav>

    <div class="db-status offline" id="dbStatus"><span class="dot"></span><span id="dbText">Connecting...</span></div>

    <section class="hero">
        <h1 class="hero-title"><i class="fas fa-trophy"></i> LEADERBOARD</h1>
        <p class="hero-subtitle">Top Members Ranking by Status</p>
    </section>
    <div class="podium-container">
        <div class="podium" id="podium">
            <div class="loading-state"><div class="loading-spinner"></div><p>Loading rankings...</p></div>
        </div>
    </div>

    <div class="leaderboard-container">
        <h2 class="section-title"><i class="fas fa-list-ol"></i> Complete Rankings</h2>
        <div class="leaderboard-list" id="leaderboardList">
            <div class="loading-state"><div class="loading-spinner"></div></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // ✅ YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://qrqsdcvvbpzerembucky.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_K0XFvmcRg4nQI5qJAY7rMA_1HyJssf_'

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)
        
        // Status ranking (higher number = higher rank)
        const STATUS_RANK = {
            'Founder': 4,
            'Admin': 3,
            'VIP': 2,
            'Member': 1
        }

        let realtimeChannel = null
        let isConnected = false

        // Test connection first
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('members').select('count', { count: 'exact', head: true })
                if (error) throw error
                return true
            } catch (err) {
                console.error('Connection test failed:', err)
                return false
            }
        }

        async function initLeaderboard() {
            const statusEl = document.getElementById('dbStatus')
            const statusText = document.getElementById('dbText')
            const podium = document.getElementById('podium')            const list = document.getElementById('leaderboardList')
            
            try {
                // Test connection first
                const connected = await testConnection()
                if (!connected) {
                    throw new Error('Cannot connect to Supabase database')
                }
                
                // Fetch data
                const { data, error } = await supabase.from('members').select('*')
                if (error) throw error
                
                statusEl.className = 'db-status online'
                statusText.innerText = '● Live'
                isConnected = true
                
                const sortedMembers = sortMembersByStatus(data || [])
                
                if (sortedMembers.length === 0) {
                    showEmptyState()
                } else {
                    renderPodium(sortedMembers.slice(0, 3))
                    renderLeaderboard(sortedMembers)
                }
                
                setupRealtime()
            } catch (err) {
                console.error('Leaderboard error:', err)
                statusEl.className = 'db-status offline'
                statusText.innerText = '● Offline'
                showError(err.message)
            }
        }

        function sortMembersByStatus(members) {
            return members.sort((a, b) => {
                const rankA = STATUS_RANK[a.status] || 0
                const rankB = STATUS_RANK[b.status] || 0
                if (rankB !== rankA) return rankB - rankA
                return new Date(b.created_at) - new Date(a.created_at)
            })
        }

        function renderPodium(top3) {
            const podium = document.getElementById('podium')
            if (top3.length === 0) {
                podium.innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i><p>No members yet</p></div>'
                return
            }
            const podiumOrder = []
            if (top3[1]) podiumOrder.push({ ...top3[1], position: 2 })
            if (top3[0]) podiumOrder.push({ ...top3[0], position: 1 })
            if (top3[2]) podiumOrder.push({ ...top3[2], position: 3 })

            podium.innerHTML = podiumOrder.map((member) => {
                const rankClass = member.position === 1 ? 'gold' : member.position === 2 ? 'silver' : 'bronze'
                const rankBadgeClass = `rank-${member.position}`
                const photoUrl = member.photo && member.photo.length > 10 
                    ? member.photo 
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=7b68ee&color=fff&size=200`
                
                return `
                    <div class="podium-item ${rankClass}">
                        <div class="podium-card">
                            <div class="rank-badge ${rankBadgeClass}">${member.position}</div>
                            <div class="podium-photo">
                                <img src="${photoUrl}" alt="${member.name}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=333&color=fff&size=100'">
                            </div>
                            <div class="podium-name">${member.name}</div>
                            <div class="podium-title">${member.title}</div>
                            <span class="podium-status status-${(member.status||'member').toLowerCase()}">${member.status||'Member'}</span>
                        </div>
                    </div>
                `
            }).join('')
        }

        function renderLeaderboard(sortedMembers) {
            const list = document.getElementById('leaderboardList')
            if (sortedMembers.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No members to display</p></div>'
                return
            }

            list.innerHTML = sortedMembers.map((member, index) => {
                const rank = index + 1
                const rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : 'normal'
                const photoUrl = member.photo && member.photo.length > 10 
                    ? member.photo 
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=7b68ee&color=fff&size=100`
                
                return `
                    <div class="leader-item" style="animation-delay: ${index * 0.05}s">
                        <div class="leader-rank ${rankClass}">${rank}</div>
                        <div class="leader-photo">
                            <img src="${photoUrl}" alt="${member.name}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=333&color=fff&size=100'">
                        </div>
                        <div class="leader-info">                            <div class="leader-name">${member.name}</div>
                            <div class="leader-title">${member.title}</div>
                            <div class="leader-id">ID: ${member.member_id}</div>
                        </div>
                        <span class="leader-status status-${(member.status||'member').toLowerCase()}">${member.status||'Member'}</span>
                    </div>
                `
            }).join('')
        }

        function setupRealtime() {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel)
            
            realtimeChannel = supabase.channel('public:members')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, 
                    async () => {
                        const { data } = await supabase.from('members').select('*')
                        const sortedMembers = sortMembersByStatus(data || [])
                        renderPodium(sortedMembers.slice(0, 3))
                        renderLeaderboard(sortedMembers)
                    }
                )
                .subscribe()
        }

        function showEmptyState() {
            document.getElementById('podium').innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i><p>No members yet</p></div>'
            document.getElementById('leaderboardList').innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No members to display</p></div>'
        }

        function showError(msg) {
            const errorHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to Load Leaderboard</h3>
                    <p>${msg}</p>
                    <code>Check: 1) Table exists 2) RLS disabled 3) Internet connection</code>
                    <button class="btn-retry" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `
            document.getElementById('podium').innerHTML = errorHTML
            document.getElementById('leaderboardList').innerHTML = ''
        }

        window.addEventListener('beforeunload', () => {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel)
        })
        document.addEventListener('DOMContentLoaded', initLeaderboard)
    </script>
</body>
</html>
